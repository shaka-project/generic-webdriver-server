<!DOCTYPE html>
<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
  <head>
    <title>Chromecast WebDriver Receiver</title>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>

html, body, iframe {
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
  background: white;
}

iframe {
  border: none;
}

    </style>
    <script>

window.addEventListener('DOMContentLoaded', async () => {
  // In v1.0 and v1.1, the location contained only a URL.
  // In v1.2+, the location contains JSON data.
  // This receiver is backward compatible with older clients.
  let parameters;
  try {
    // Ignore the leading '?'.  The rest is JSON data.
    parameters = JSON.parse(decodeURI(location.search.substr(1)));
  } catch (error) {
    parameters = {
      // Ignore the leading '?'.  The rest is a URL.
      url: (location.search + location.hash).substr(1),
    };
  }

  const frameUrl = parameters.url;
  const statusText = 'URL: ' + frameUrl;

  const context = cast.framework.CastReceiverContext.getInstance();
  context.start({
    statusText,
    disableIdleTimeout: true,
  });

  // Some features must be explicitly allowed for an iframe.
  // These are needed for media-related testing.
  // TODO: Make this list configurable.
  // See also: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Feature-Policy
  const allowedFeatures = [
    'autoplay',
    'encrypted-media',
    'fullscreen',
    'picture-in-picture',
    'sync-xhr',
  ];

  window.frame.allow = allowedFeatures.join('; ');

  if (parameters.forceSameOrigin) {
    // Dynamically load the frame URL's contents.  We then modify the contents
    // to fix relative links and expose the Cast platform APIs.
    const response = await fetch(frameUrl);
    let text = await response.text();

    // Makes sure relative links will still work in the document.
    const baseElement = `<base href="${frameUrl}">`;

    // Pulls the top-level cast platform methods down into the iframe.
    const pullCast = 'cast.__platform__ = window.top.cast.__platform__;';
    const scriptElement = `<script>${pullCast}<\/script>`;

    // Inject these features into the page source.
    text = text.replace(/(<head\s?[^>]*>)/, `$1${baseElement}${scriptElement}`);

    // Load the document as text, so that it is in the same origin as this
    // receiver.  That allows the test iframe to access the top-level
    // cast.__platform__.
    window.frame.srcdoc = text;
  } else {
    window.frame.src = frameUrl;
  }
});

    </script>
  </head>
  <body>
    <iframe id="frame"></iframe>
  </body>
</html>
